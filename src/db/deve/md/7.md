# [git action] 배포 자동화 구현

## [번외] 문제의 발단

### 현재까지 배포구조 및 단계

1. 로컬에서 원하는 코드를 작성한다. 
2. 로컬에서 docker build를 하고 dockerhub에 push한다
3. ssh를 통해 배포환경에 원격 접속
4. docker-compose down을 해주고 이전에 구동되던 이미지를 지워준다
5. docker-compose up를 통해 image 를 pull 하는 동시에 docker run 으로 배포를 완료한다.

### 문제점

- 로컬에서 직접 docker build를 해주는 동안 다른 작업을 할 수 없다는 문제가 발생
- docker push 하는 동안도 마찬가지
- ssh를 통해 배포 환경에 그때그때 접속해줘야됨
- 직접 이전 이미지를 지우고 새로운 이미지를 배포해줘야됨

## 1. git action 

- 앞에서 언급한 문제들을 해결하기 위해 찾아낸 방법이 바로 git action이었다
- 이는 내가 git에서 하는 모든 action을 인지하고 이 action에 대해 어떠한 작업을 실행할지 명령해줄 수 있는 것이다
- 이를 통해 나는 git push하는 동시에 내가 지금까지 해오던 docker build부터 docker run까지 명령하고 하였다
- 먼저 git action을 사용하기 위해서는 프로젝트 폴더 최상단에 .github라는 폴더를 생성해야 한다.
- 그리고 .github폴더 내부에 workflows라는 폴더를 한번 더 생성해야 한다 이때 경로와 폴더 이름은 절대 바뀔 수 없다
- 마지막으로 workflows폴더 내부에 ~.yml이라는 파일을 생성하고 어떤 작업을 해줄 것인지 작성해주면 된다

```yml
name: Docker Image CI

on:
  #dev로 푸시 및 풀 리퀘스트시에 event 발생시 동작
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  build:
    #리눅스 우분투 사용
    runs-on: ubuntu-latest

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      #1. touch .env
      - name: Make .env
        run: |
          touch ./.env
          echo "${{ secrets.ENV }}" >> ./.env
        shell: bash

      #도커 빌드 셋업
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      #2. docker login
      - name: Login to Dockerhub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD}}

      #3. docker build and push
      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64/v8
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/blog-fe:latest

          #build용 캐시를 사용, 여기서 gha 는 Guthub Actions 용 캐시를 의미합니다.
          cache-from: type=gha
          cache-to: type=gha,mode=max

      #4. docker pull and run
      - name: Pull and Run
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ~/docker-compose/blog/blog-fe
            docker-compose down
            docker rmi $(docker images | grep "${{ secrets.DOCKER_USERNAME }}/blog-fe" | awk '{print $3}')
            docker-compose up -d
            exit



```

- 나는 다음과 같이 명령어를 작성해줬다. 뒤이어 코드 하나하나가 어떤의미인지 다뤄보도록 하겠다

## 2. name, on, jobs

- name: 해주고자 하는 작업의 이름을 명명하는 단계로 모든 작업을 name을 기준으로 구분된다
- on: 어떤 action을 listening할 것인지 정해주고 어떤 branch에 의한 action에 작업을 실행할 것인지도 정해줄 수 있다
- jobs: 먼저 어떤 작업을 할 것인지 알려준다.(나는 build라는 작업을 명령했다) 그리고 어떤 환경에서 작업할 것인지 알려줘야 하는데 나처럼 ubuntu-latest라고 명령해 줄 경우 git에서 제공하는 ubuntu를 재원을 사용하여 작업을 실행할 수 있고 만약 self-hosted라고 명령해 줄 경우 내가 직접 내 local환경에 runner를 설치하여 작업을 진행해 줄 수 있다. 그리고 마지막으로 steps밑에 내가 하고자 하는 모든 작업을 작성해 주면 된다

## 3. steps

### 1) Make .env
- git에는 .env가 존재하지 않아 환경변수를 읽을 수 없으므로 환경변수를 설정해줄 필요성을 그꼈다
- 그래서 나는 그냥 .env를 만들어 버려서 그 안에 내용을 똑같이 작성하는 방법을 택했다

```yml
- name: Make .env
        run: |
          touch ./.env
          echo "${{ secrets.ENV }}" >> ./.env
        shell: bash
```

- git secrets에 .nev파일을 똑같이 만들어 놨따가 작업을 실행할때 직접 .env를 만들어 내용을 넣어주는 것이다.

### 2) docker login

- git secrets에 저장해 놓은 docker 아이디와 패스워드를 통해 docker에 login해준다

```yml
- name: Login to Dockerhub
    uses: docker/login-action@v1
    with:
      username: ${{ secrets.DOCKER_USERNAME }}
      password: ${{ secrets.DOCKER_PASSWORD}}
```

### 3) docker build and push 

- docker/build-push-action@v2라는 라이브러리 비슷한 것을 사용하여 docker image를 빌드해준다.
- 이때 platform과 태그를 붙여줄 수 있다 
- push: true로 설정하여 image를 push해준다

```yml
- name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64/v8
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/blog-fe:latest

          #build용 캐시를 사용, 여기서 gha 는 Guthub Actions 용 캐시를 의미합니다.
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

- cache를 사용하여 다음번에 build하는 경우 build시간을 단축할 수 있다

### 4) docker pull and run

- aplleboy/ssh-action@master를 사용하여 배포환경에 ssh로 접속하여 내가 손으로 하던 docker-compose down, docker rmi, docker-compose up을 해준다

```yml
- name: Pull and Run
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ~/docker-compose/blog/blog-fe
            docker-compose down
            docker rmi $(docker images | grep "${{ secrets.DOCKER_USERNAME }}/blog-fe" | awk '{print $3}')
            docker-compose up -d
            exit
```

- 이때도 git secrets에 저장해놓은 host, username, password, port를 통해 ssh를 접속할 수 있다
- 접속한 이후에는 내가 하고자 하는 작업을 단계별로 script에 작성해 주면 된다
- 혹시 모르니 작업을 모두 마친뒤에는 exit해주는 것을 까먹지 말자


- 이렇게 모든 단계가 끝났다. 이제 git push만 하면 모든 배포과정이 자동으로 이루어 지게 되었다 !!
